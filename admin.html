<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Spectrum CRM â€” Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="Admin console for CSV import/export and data management" name="description" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <!-- Favicon -->
  <link rel="icon" href="data:,">

  <!-- Plugins CSS -->
  <link href="plugins/jvectormap/jquery-jvectormap-2.0.2.css" rel="stylesheet">

  <!-- Core CSS -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/jquery-ui.min.css" rel="stylesheet" />
  <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/metisMenu.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/app.min.css" rel="stylesheet" type="text/css" />
</head>

<body>

<script>
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "login.html"; 
      return;
    }
    const doc = await firebase.firestore().collection("users").doc(user.uid).get();
    const role = doc.exists ? doc.data().role : "frontdesk";
    window.currentRole = role;
    const path = window.location.pathname.split("/").pop();
    const adminOnly = ["admin.html"];
    const marketingOnly = ["marketing.html","projects.html","gallery.html"];
    if (adminOnly.includes(path) && role !== "admin") window.location.href="unauthorized.html";
    if (marketingOnly.includes(path) && role==="frontdesk") window.location.href="unauthorized.html";
  });
</script>

  <!-- Top Bar Start -->
  <div class="topbar">
    <div class="topbar-left">
      <a href="index.html" class="logo">
        <span>
          <img src="assets/images/logo-sm.png" alt="logo-small" class="logo-sm">
        </span>
        <span>
          <img src="assets/images/logo.png" alt="logo-large" class="logo-lg logo-light">
          <img src="assets/images/logo-dark.png" alt="logo-large" class="logo-lg">
        </span>
      </a>
    </div>

    <nav class="navbar-custom">
      <ul class="list-unstyled topbar-nav float-right mb-0">
        <li class="dropdown notification-list">
          <a class="nav-link dropdown-toggle arrow-none waves-light waves-effect" data-toggle="dropdown" href="#" role="button">
            <i class="ti-bell noti-icon"></i>
            <span class="badge badge-danger badge-pill noti-icon-badge">2</span>
          </a>
          <div class="dropdown-menu dropdown-menu-right dropdown-lg pt-0">
            <h6 class="dropdown-item-text font-15 m-0 py-3 bg-primary text-white d-flex justify-content-between align-items-center">
              Notifications <span class="badge badge-light badge-pill">2</span>
            </h6>
            <div class="slimscroll notification-list">
              <a href="#" class="dropdown-item py-3">
                <small class="float-right text-muted pl-2">2 min ago</small>
                <div class="media">
                  <div class="avatar-md bg-primary"><i class="la la-cart-arrow-down text-white"></i></div>
                  <div class="media-body align-self-center ml-2 text-truncate">
                    <h6 class="my-0 font-weight-normal text-dark">Your order is placed</h6>
                    <small class="text-muted mb-0">Dummy text of the printing and industry.</small>
                  </div>
                </div>
              </a>
              <a href="#" class="dropdown-item py-3">
                <small class="float-right text-muted pl-2">10 min ago</small>
                <div class="media">
                  <div class="avatar-md bg-success"><i class="la la-group text-white"></i></div>
                  <div class="media-body align-self-center ml-2 text-truncate">
                    <h6 class="my-0 font-weight-normal text-dark">Meeting with designers</h6>
                    <small class="text-muted mb-0">It is a long established fact that a reader.</small>
                  </div>
                </div>
              </a>
            </div>
            <a href="#" class="dropdown-item text-center text-primary">View all <i class="fi-arrow-right"></i></a>
          </div>
        </li>

        <li class="dropdown">
          <a class="nav-link dropdown-toggle waves-effect waves-light nav-user" data-toggle="dropdown" href="#" role="button">
            <img src="assets/images/users/user-1.png" alt="profile-user" class="rounded-circle" />
            <span class="ml-1 nav-user-name hidden-sm">Amelia <i class="mdi mdi-chevron-down"></i></span>
          </a>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="#"><i class="ti-user text-muted mr-2"></i> Profile</a>
            <a class="dropdown-item" href="#"><i class="ti-settings text-muted mr-2"></i> Settings</a>
            <div class="dropdown-divider mb-0"></div>
            <a class="dropdown-item" href="#"><i class="ti-power-off text-muted mr-2"></i> Logout</a>
          </div>
        </li>
      </ul>

      <ul class="list-unstyled topbar-nav mb-0">
        <li>
          <button class="nav-link button-menu-mobile waves-effect waves-light">
            <i class="ti-menu nav-icon"></i>
          </button>
        </li>
        <li class="hide-phone app-search">
          <form role="search">
            <input type="text" id="AllCompo" placeholder="Search..." class="form-control">
            <a href=""><i class="fas fa-search"></i></a>
          </form>
        </li>
      </ul>
    </nav>
  </div>
  <!-- Top Bar End -->

<div class="left-sidenav">
  <ul class="metismenu left-sidenav-menu">

    <!-- Dashboards -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-bar-chart"></i><span>Dashboard</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="crm.html"><i class="ti-control-record"></i>CRM</a></li>
        <li class="nav-item"><a class="nav-link" href="analytics.html"><i class="ti-control-record"></i>Analytics</a></li>
        <li class="nav-item"><a class="nav-link" href="helpdesk.html"><i class="ti-control-record"></i>Helpdesk</a></li>
        <li class="nav-item"><a class="nav-link" href="sales.html"><i class="ti-control-record"></i>Sales (Admin)</a></li>
      </ul>
    </li>

    <!-- Medspa Dashboards -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-layers-alt"></i><span>Medspa Dashboards</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="marketing.html"><i class="ti-control-record"></i>Marketing</a></li>
        <li class="nav-item"><a class="nav-link" href="financial.html"><i class="ti-control-record"></i>Financial</a></li>
        <li class="nav-item"><a class="nav-link" href="operations.html"><i class="ti-control-record"></i>Operations</a></li>
      </ul>
    </li>

    <!-- Pipeline -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-user"></i><span>Pipeline</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="leads.html"><i class="ti-control-record"></i>Leads</a></li>
        <li class="nav-item"><a class="nav-link" href="followups.html"><i class="ti-control-record"></i>Follow-ups</a></li>
        <li class="nav-item"><a class="nav-link" href="rebooking.html"><i class="ti-control-record"></i>Rebookings</a></li>
      </ul>
    </li>

    <!-- Apps -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-package"></i><span>Apps</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="app-email.html"><i class="ti-control-record"></i>Email (Google)</a></li>
        <li class="nav-item"><a class="nav-link" href="app-chat.html"><i class="ti-control-record"></i>Chat (Google)</a></li>
        <li class="nav-item"><a class="nav-link" href="app-contacts.html"><i class="ti-control-record"></i>Contact List</a></li>
        <li class="nav-item"><a class="nav-link" href="app-calendar.html"><i class="ti-control-record"></i>Calendar (Google)</a></li>
        <li class="nav-item"><a class="nav-link" href="quotes.html"><i class="ti-control-record"></i>Treatment Quotes</a></li>
      </ul>
    </li>

    <!-- Projects -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-pencil-alt"></i><span>Projects</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="projects.html"><i class="ti-control-record"></i>Publer-style Publishing</a></li>
      </ul>
    </li>

    <!-- Admin -->
    <li>
      <a href="javascript:void(0);"><i class="ti-settings"></i><span>Admin</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span></a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link active" href="admin.html"><i class="ti-control-record"></i>Admin Console</a></li>
      </ul>
    </li>

    <!-- Pages -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-agenda"></i><span>Pages</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="vendors.html"><i class="ti-control-record"></i>Vendor Mgmt & Purchasing</a></li>
        <li class="nav-item"><a class="nav-link" href="inventory.html"><i class="ti-control-record"></i>Inventory</a></li>
        <li class="nav-item"><a class="nav-link" href="pricing.html"><i class="ti-control-record"></i>Pricing</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html"><i class="ti-control-record"></i>Gallery</a></li>
      </ul>
    </li>

  </ul>
</div>

  <div class="page-wrapper">
    <div class="page-content">
      <div class="container-fluid">
        <!-- Breadcrumb + Title -->
        <div class="row">
          <div class="col-sm-12">
            <div class="page-title-box">
              <div class="float-right">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="#">Crovex</a></li>
                  <li class="breadcrumb-item"><a href="#">Admin</a></li>
                  <li class="breadcrumb-item active">Console</li>
                </ol>
              </div>
              <h4 class="page-title">Admin Console</h4>
            </div>
          </div>
        </div>

        <!-- Admin Content -->
        <div class="row">
          <!-- Pricing & Services -->
          <div class="col-xl-6">
            <div class="card">
              <div class="card-body">
                <h4 class="header-title">Pricing & Services</h4>
                <p class="text-muted">Import/Export services data from Blvd or compatible systems.</p>
                
                <div class="mb-3">
                  <input type="file" id="pricingFile" accept=".csv" class="form-control-file mb-2">
                  <button class="btn btn-primary btn-sm mr-2" onclick="importPricing()">Import CSV</button>
                  <button class="btn btn-secondary btn-sm mr-2" onclick="exportPricing()">Export CSV</button>
                  <button class="btn btn-success btn-sm mr-2" onclick="savePricingToFirestore()">Save to Firestore</button>
                  <button class="btn btn-info btn-sm" onclick="syncPricingWithCloud()">Sync with Cloud</button>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-sm" id="pricingTable">
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Service</th>
                        <th>Price</th>
                        <th>Active</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="4" class="text-muted text-center">No data loaded</td></tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info">
                  <small><strong>CSV Headers (required order):</strong><br>
                  category,service,price,active
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Leads & Follow-ups -->
          <div class="col-xl-6">
            <div class="card">
              <div class="card-body">
                <h4 class="header-title">Leads & Follow-ups CSV</h4>
                <p class="text-muted">Import/Export leads data for CRM management.</p>
                
                <div class="mb-3">
                  <input type="file" id="leadsFile" accept=".csv" class="form-control-file mb-2">
                  <button class="btn btn-primary btn-sm mr-2" onclick="importLeads()">Import Leads CSV</button>
                  <button class="btn btn-secondary btn-sm mr-2" onclick="exportLeads()">Export Leads CSV</button>
                  <button class="btn btn-info btn-sm" onclick="syncLeadsWithCloud()">Sync with Cloud</button>
                </div>
                
                <div class="alert alert-info">
                  <small><strong>CSV Headers:</strong><br>
                  id,name,phone,email,source,category,service,value,priority,stage,created,apptDate,dueDate,dueTime,notes
                  </small>
                </div>
                
                <div id="leadsStatus" class="text-muted"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Roles Management -->
        <div class="row">
          <div class="col-xl-12">
            <div class="card">
              <div class="card-body">
                <h4 class="header-title">User Roles Management</h4>
                <p class="text-muted">Manage user roles and permissions. Only admins can modify roles.</p>
                
                <div class="table-responsive">
                  <table class="table table-striped" id="usersTable">
                    <thead>
                      <tr>
                        <th>Email</th>
                        <th>Display Name</th>
                        <th>Current Role</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableBody">
                      <tr>
                        <td colspan="4" class="text-center text-muted">Loading users...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <button id="btnRefreshUsers" class="btn btn-outline-primary">Refresh Users</button>
              </div>
            </div>
          </div>
        </div>

      </div><!-- container -->

      <footer class="footer text-center text-sm-left">
        &copy; 2020 Crovex
        <span class="text-muted d-none d-sm-inline-block float-right">Crafted with <i class="mdi mdi-heart text-danger"></i> by Mannatthemes</span>
      </footer>
    </div>
  </div>

  <!-- Core JS -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/metismenu.min.js"></script>
  <script src="assets/js/waves.js"></script>
  <script src="assets/js/feather.min.js"></script>
  <script src="assets/js/jquery.slimscroll.min.js"></script>
  <script src="assets/js/jquery-ui.min.js"></script>

  <!-- Plugins -->
  <script src="plugins/moment/moment.js"></script>
  <script src="plugins/apexcharts/apexcharts.min.js"></script>
  <script src="plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
  <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
  <script src="plugins/flot-chart/jquery.flot.js"></script>
  <script src="plugins/flot-chart/jquery.flot.saturated.js"></script>
  <script src="plugins/flot-chart/jquery.flot.browser.js"></script>
  <script src="plugins/flot-chart/jquery.flot.drawSeries.js"></script>
  <script src="plugins/flot-chart/jquery.flot.uiConstants.js"></script>

  <!-- Page init -->
  <script src="assets/pages/jquery.crm_dashboard.init.js"></script>

  <!-- App js -->
  <script src="assets/js/app.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <script src="assets/js/firebase-config.js"></script>

  <!-- Admin CSV Functions -->
  <script>
    let pricingData = [];
    let leadsData = [];

    // Simple CSV parser
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (!lines.length) return [];
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const rows = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        rows.push(row);
      }
      return rows;
    }

    // Convert data to CSV
    function dataToCSV(data, headers) {
      if (!data.length) return '';
      const csvRows = [headers.join(',')];
      data.forEach(row => {
        const values = headers.map(header => {
          let value = row[header] || '';
          if (value.includes(',') || value.includes('"')) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        csvRows.push(values.join(','));
      });
      return csvRows.join('\n');
    }

    // Download CSV
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Firestore helper functions
    async function checkAuth() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Please sign in to access Firestore functionality');
        return false;
      }
      return true;
    }

    // Pricing functions
    function importPricing() {
      const file = document.getElementById('pricingFile').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const rawData = parseCSV(e.target.result);
          
          // Validate CSV headers
          if (rawData.length === 0) {
            alert('CSV file is empty');
            return;
          }
          
          const firstRow = rawData[0];
          const requiredHeaders = ['category', 'service', 'price', 'active'];
          const hasRequiredHeaders = requiredHeaders.every(header => 
            Object.keys(firstRow).some(key => key.toLowerCase().trim() === header)
          );
          
          if (!hasRequiredHeaders) {
            alert('Invalid Services CSV format. Required: category,service,price,active');
            return;
          }
          
          // Process and filter data
          pricingData = rawData
            .map(row => {
              // Normalize and clean data
              const category = (row.category || '').toString().trim();
              const service = (row.service || '').toString().trim();
              const priceStr = (row.price || '0').toString().trim();
              const activeStr = (row.active || 'false').toString().trim().toLowerCase();
              
              // Parse price safely
              let price = parseFloat(priceStr);
              if (isNaN(price)) price = 0;
              
              // Parse active field
              const active = activeStr === 'true' || activeStr === '1' || activeStr === 'yes';
              
              return {
                category,
                service,
                price,
                active
              };
            })
            .filter(row => row.active && row.service.length > 0); // Only import active services
          
          renderPricingTable();
          alert(`Imported ${pricingData.length} active services`);
        } catch (error) {
          alert('Error parsing CSV: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    async function exportPricing() {
      try {
        // Try to get data from Firestore first, fallback to local data
        const snapshot = await db.collection('pricing').get();
        const firestoreData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          firestoreData.push({
            category: data.category || '',
            service: data.service || '',
            price: data.price || 0,
            active: data.active || false
          });
        });
        
        const data = firestoreData.length ? firestoreData : pricingData;
        const headers = ['category', 'service', 'price', 'active'];
        const csv = dataToCSV(data, headers);
        downloadCSV(csv, 'services-export.csv');
      } catch (error) {
        console.error('Error exporting from Firestore, using local data:', error);
        const headers = ['category', 'service', 'price', 'active'];
        const csv = dataToCSV(pricingData, headers);
        downloadCSV(csv, 'services-export.csv');
      }
    }

    async function savePricingToFirestore() {
      if (!await checkAuth()) return;
      
      try {
        const batch = db.batch();
        
        pricingData.forEach(row => {
          if (row.service) {
            // Generate document ID from service name (lowercased with dashes)
            const docId = row.service.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const docRef = db.collection('pricing').doc(docId);
            batch.set(docRef, {
              category: row.category || '',
              service: row.service || '',
              price: parseFloat(row.price) || 0,
              active: true // Only save active services
            });
          }
        });
        
        await batch.commit();
        alert('Services data saved to Firestore');
      } catch (error) {
        alert('Error saving to Firestore: ' + error.message);
      }
    }

    async function syncPricingWithCloud() {
      if (!await checkAuth()) return;
      
      try {
        // Save current data to Firestore
        await savePricingToFirestore();
        
        // Load from Firestore
        const snapshot = await db.collection('pricing').get();
        pricingData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          pricingData.push({
            category: data.category || '',
            service: data.service || '',
            price: data.price || 0,
            active: data.active || false
          });
        });
        
        renderPricingTable();
        alert('Synced with Firestore successfully');
      } catch (error) {
        alert('Error syncing with Firestore: ' + error.message);
      }
    }

    function renderPricingTable() {
      const tbody = document.querySelector('#pricingTable tbody');
      if (!pricingData.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No data loaded</td></tr>';
        return;
      }
      
      tbody.innerHTML = pricingData.map(row => `
        <tr>
          <td>${row.category || ''}</td>
          <td>${row.service || ''}</td>
          <td>$${parseFloat(row.price || 0).toFixed(2)}</td>
          <td><span class="badge badge-${row.active ? 'success' : 'secondary'}">${row.active ? 'Active' : 'Inactive'}</span></td>
        </tr>
      `).join('');
    }

    // Leads functions
    function importLeads() {
      const file = document.getElementById('leadsFile').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          leadsData = parseCSV(e.target.result);
          document.getElementById('leadsStatus').innerHTML = `Imported ${leadsData.length} leads to memory`;
        } catch (error) {
          alert('Error parsing leads CSV: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    async function exportLeads() {
      try {
        // Try to get data from Firestore first, fallback to local data
        const snapshot = await db.collection('leads').get();
        const firestoreData = [];
        snapshot.forEach(doc => {
          firestoreData.push({ id: doc.id, ...doc.data() });
        });
        
        const data = firestoreData.length ? firestoreData : leadsData;
        const headers = ['id', 'name', 'phone', 'email', 'source', 'category', 'service', 'value', 'priority', 'stage', 'created', 'apptDate', 'dueDate', 'dueTime', 'notes'];
        const csv = dataToCSV(data, headers);
        downloadCSV(csv, 'leads-export.csv');
      } catch (error) {
        console.error('Error exporting from Firestore, using local data:', error);
        const headers = ['id', 'name', 'phone', 'email', 'source', 'category', 'service', 'value', 'priority', 'stage', 'created', 'apptDate', 'dueDate', 'dueTime', 'notes'];
        const csv = dataToCSV(leadsData, headers);
        downloadCSV(csv, 'leads-export.csv');
      }
    }

    async function syncLeadsWithCloud() {
      if (!await checkAuth()) return;
      
      try {
        // Save current data to Firestore
        if (leadsData.length) {
          const batch = db.batch();
          
          leadsData.forEach(row => {
            if (row.id) {
              const docRef = db.collection('leads').doc(row.id);
              batch.set(docRef, {
                name: row.name || '',
                phone: row.phone || '',
                email: row.email || '',
                source: row.source || '',
                category: row.category || '',
                service: row.service || '',
                value: row.value || '',
                priority: row.priority || '',
                stage: row.stage || '',
                created: row.created || '',
                apptDate: row.apptDate || '',
                dueDate: row.dueDate || '',
                dueTime: row.dueTime || '',
                notes: row.notes || ''
              });
            }
          });
          
          await batch.commit();
        }
        
        // Load from Firestore
        const snapshot = await db.collection('leads').get();
        const count = snapshot.size;
        document.getElementById('leadsStatus').innerHTML = `Synced ${count} leads with Firestore`;
      } catch (error) {
        alert('Error syncing leads with Firestore: ' + error.message);
      }
    }

    // User management functions
    async function loadUsers() {
      try {
        const users = await getAllUsers();
        const tbody = document.getElementById('usersTableBody');
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No users found</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.email || 'N/A'}</td>
            <td>${user.displayName || 'N/A'}</td>
            <td>
              <span class="badge badge-${getRoleBadgeColor(user.role)}">${user.role || 'frontdesk'}</span>
            </td>
            <td>
              <select class="form-control-sm" onchange="changeUserRole('${user.uid}', this.value)" ${window.currentRole !== 'admin' ? 'disabled' : ''}>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                <option value="frontdesk" ${user.role === 'frontdesk' || !user.role ? 'selected' : ''}>Front Desk</option>
                <option value="marketing" ${user.role === 'marketing' ? 'selected' : ''}>Marketing</option>
              </select>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading users</td></tr>';
      }
    }
    
    function getRoleBadgeColor(role) {
      switch (role) {
        case 'admin': return 'danger';
        case 'marketing': return 'info';
        case 'frontdesk': return 'success';
        default: return 'secondary';
      }
    }
    
    async function changeUserRole(uid, newRole) {
      if (window.currentRole !== 'admin') {
        alert('Only admins can change user roles');
        return;
      }
      
      try {
        const success = await updateUserRole(uid, newRole);
        if (success) {
          alert('User role updated successfully');
          loadUsers(); // Refresh the table
        } else {
          alert('Failed to update user role');
        }
      } catch (error) {
        alert('Error updating user role: ' + error.message);
      }
    }

    // Load existing data on page load
    $(function() {
      feather && feather.replace();
      
      // Load data from Firestore when authenticated
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          try {
            // Load pricing from Firestore
            const pricingSnapshot = await db.collection('pricing').get();
            if (!pricingSnapshot.empty) {
              pricingData = [];
              pricingSnapshot.forEach(doc => {
                const data = doc.data();
                pricingData.push({
                  category: data.category || '',
                  service: data.service || '',
                  price: data.price || 0,
                  active: data.active || false
                });
              });
              renderPricingTable();
            }
            
            // Show leads count from Firestore
            const leadsSnapshot = await db.collection('leads').get();
            const leadsCount = leadsSnapshot.size;
            if (leadsCount > 0) {
              document.getElementById('leadsStatus').innerHTML = `${leadsCount} leads in Firestore`;
            }
            
            // Load users for management
            loadUsers();
          } catch (error) {
            console.error('Error loading data from Firestore:', error);
          }
        }
      });
      
      // Refresh users button
      document.getElementById('btnRefreshUsers')?.addEventListener('click', loadUsers);
    });
  </script>
</body>
</html>