<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Spectrum CRM — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta content="Admin console for CSV import/export and data management" name="description" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <!-- Favicon -->
  <link rel="icon" href="data:,">

  <!-- Plugins CSS -->
  <link href="plugins/jvectormap/jquery-jvectormap-2.0.2.css" rel="stylesheet">

  <!-- Core CSS -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/jquery-ui.min.css" rel="stylesheet" />
  <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/metisMenu.min.css" rel="stylesheet" type="text/css" />
  <link href="assets/css/app.min.css" rel="stylesheet" type="text/css" />
</head>

<body>

<script>
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "login.html"; 
      return;
    }
    const doc = await firebase.firestore().collection("users").doc(user.uid).get();
    const role = doc.exists ? doc.data().role : "frontdesk";
    window.currentRole = role;
    const path = window.location.pathname.split("/").pop();
    const adminOnly = ["admin.html"];
    const marketingOnly = ["marketing.html","projects.html","gallery.html"];
    if (adminOnly.includes(path) && role !== "admin") window.location.href="unauthorized.html";
    if (marketingOnly.includes(path) && role==="frontdesk") window.location.href="unauthorized.html";
  });
</script>

  <!-- Top Bar Start -->
  <div class="topbar">
    <div class="topbar-left">
      <a href="index.html" class="logo">
        <span>
          <img src="assets/images/logo-sm.png" alt="logo-small" class="logo-sm">
        </span>
        <span>
          <img src="assets/images/logo.png" alt="logo-large" class="logo-lg logo-light">
          <img src="assets/images/logo-dark.png" alt="logo-large" class="logo-lg">
        </span>
      </a>
    </div>

    <nav class="navbar-custom">
      <ul class="list-unstyled topbar-nav float-right mb-0">
        <li class="dropdown notification-list">
          <a class="nav-link dropdown-toggle arrow-none waves-light waves-effect" data-toggle="dropdown" href="#" role="button">
            <i class="ti-bell noti-icon"></i>
            <span class="badge badge-danger badge-pill noti-icon-badge">2</span>
          </a>
          <div class="dropdown-menu dropdown-menu-right dropdown-lg pt-0">
            <h6 class="dropdown-item-text font-15 m-0 py-3 bg-primary text-white d-flex justify-content-between align-items-center">
              Notifications <span class="badge badge-light badge-pill">2</span>
            </h6>
            <div class="slimscroll notification-list">
              <a href="#" class="dropdown-item py-3">
                <small class="float-right text-muted pl-2">2 min ago</small>
                <div class="media">
                  <div class="avatar-md bg-primary"><i class="la la-cart-arrow-down text-white"></i></div>
                  <div class="media-body align-self-center ml-2 text-truncate">
                    <h6 class="my-0 font-weight-normal text-dark">Your order is placed</h6>
                    <small class="text-muted mb-0">Dummy text of the printing and industry.</small>
                  </div>
                </div>
              </a>
              <a href="#" class="dropdown-item py-3">
                <small class="float-right text-muted pl-2">10 min ago</small>
                <div class="media">
                  <div class="avatar-md bg-success"><i class="la la-group text-white"></i></div>
                  <div class="media-body align-self-center ml-2 text-truncate">
                    <h6 class="my-0 font-weight-normal text-dark">Meeting with designers</h6>
                    <small class="text-muted mb-0">It is a long established fact that a reader.</small>
                  </div>
                </div>
              </a>
            </div>
            <a href="#" class="dropdown-item text-center text-primary">View all <i class="fi-arrow-right"></i></a>
          </div>
        </li>

        <li class="dropdown">
          <a class="nav-link dropdown-toggle waves-effect waves-light nav-user" data-toggle="dropdown" href="#" role="button">
            <img src="assets/images/users/user-1.png" alt="profile-user" class="rounded-circle" />
            <span class="ml-1 nav-user-name hidden-sm">Amelia <i class="mdi mdi-chevron-down"></i></span>
          </a>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="#"><i class="ti-user text-muted mr-2"></i> Profile</a>
            <a class="dropdown-item" href="#"><i class="ti-settings text-muted mr-2"></i> Settings</a>
            <div class="dropdown-divider mb-0"></div>
            <a class="dropdown-item" href="#"><i class="ti-power-off text-muted mr-2"></i> Logout</a>
          </div>
        </li>
      </ul>

      <ul class="list-unstyled topbar-nav mb-0">
        <li>
          <button class="nav-link button-menu-mobile waves-effect waves-light">
            <i class="ti-menu nav-icon"></i>
          </button>
        </li>
        <li class="hide-phone app-search">
          <form role="search">
            <input type="text" id="AllCompo" placeholder="Search..." class="form-control">
            <a href=""><i class="fas fa-search"></i></a>
          </form>
        </li>
      </ul>
    </nav>
  </div>
  <!-- Top Bar End -->

<div class="left-sidenav">
  <ul class="metismenu left-sidenav-menu">

    <!-- Dashboards -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-bar-chart"></i><span>Dashboard</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="crm.html"><i class="ti-control-record"></i>CRM</a></li>
        <li class="nav-item"><a class="nav-link" href="analytics.html"><i class="ti-control-record"></i>Analytics</a></li>
        <li class="nav-item"><a class="nav-link" href="helpdesk.html"><i class="ti-control-record"></i>Helpdesk</a></li>
        <li class="nav-item"><a class="nav-link" href="sales.html"><i class="ti-control-record"></i>Sales (Admin)</a></li>
      </ul>
    </li>

    <!-- Medspa Dashboards -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-layers-alt"></i><span>Medspa Dashboards</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="marketing.html"><i class="ti-control-record"></i>Marketing</a></li>
        <li class="nav-item"><a class="nav-link" href="financial.html"><i class="ti-control-record"></i>Financial</a></li>
        <li class="nav-item"><a class="nav-link" href="operations.html"><i class="ti-control-record"></i>Operations</a></li>
      </ul>
    </li>

    <!-- Pipeline -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-user"></i><span>Pipeline</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="leads.html"><i class="ti-control-record"></i>Leads</a></li>
        <li class="nav-item"><a class="nav-link" href="followups.html"><i class="ti-control-record"></i>Follow-ups</a></li>
        <li class="nav-item"><a class="nav-link" href="rebooking.html"><i class="ti-control-record"></i>Rebookings</a></li>
      </ul>
    </li>

    <!-- Apps -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-package"></i><span>Apps</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="app-email.html"><i class="ti-control-record"></i>Email (Google)</a></li>
        <li class="nav-item"><a class="nav-link" href="app-chat.html"><i class="ti-control-record"></i>Chat (Google)</a></li>
        <li class="nav-item"><a class="nav-link" href="app-contacts.html"><i class="ti-control-record"></i>Contact List</a></li>
        <li class="nav-item"><a class="nav-link" href="app-calendar.html"><i class="ti-control-record"></i>Calendar (Google)</a></li>
        <li class="nav-item"><a class="nav-link" href="quotes.html"><i class="ti-control-record"></i>Treatment Quotes</a></li>
      </ul>
    </li>

    <!-- Projects -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-pencil-alt"></i><span>Projects</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="projects.html"><i class="ti-control-record"></i>Publer-style Publishing</a></li>
      </ul>
    </li>

    <!-- Admin -->
    <li>
      <a href="javascript:void(0);"><i class="ti-settings"></i><span>Admin</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span></a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link active" href="admin.html"><i class="ti-control-record"></i>Admin Console</a></li>
      </ul>
    </li>

    <!-- Pages -->
    <li>
      <a href="javascript:void(0);">
        <i class="ti-agenda"></i><span>Pages</span>
        <span class="menu-arrow"><i class="mdi mdi-chevron-right"></i></span>
      </a>
      <ul class="nav-second-level" aria-expanded="false">
        <li class="nav-item"><a class="nav-link" href="vendors.html"><i class="ti-control-record"></i>Vendor Mgmt & Purchasing</a></li>
        <li class="nav-item"><a class="nav-link" href="inventory.html"><i class="ti-control-record"></i>Inventory</a></li>
        <li class="nav-item"><a class="nav-link" href="pricing.html"><i class="ti-control-record"></i>Pricing</a></li>
        <li class="nav-item"><a class="nav-link" href="gallery.html"><i class="ti-control-record"></i>Gallery</a></li>
      </ul>
    </li>

  </ul>
</div>

  <div class="page-wrapper">
    <div class="page-content">
      <div class="container-fluid">
        <!-- Breadcrumb + Title -->
        <div class="row">
          <div class="col-sm-12">
            <div class="page-title-box">
              <div class="float-right">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="#">Crovex</a></li>
                  <li class="breadcrumb-item"><a href="#">Admin</a></li>
                  <li class="breadcrumb-item active">Console</li>
                </ol>
              </div>
              <h4 class="page-title">Admin Console</h4>
            </div>
          </div>
        </div>

        <!-- Admin Content -->
        <div class="row">
          <!-- Pricing & Services -->
          <div class="col-xl-6">
            <div class="card">
              <div class="card-body">
                <h4 class="header-title">Pricing & Services</h4>
                <p class="text-muted">Import/Export services data from Blvd or compatible systems.</p>
                <p class="text-muted"><small>Download sample: <a href="assets/data/dummy-services.csv" target="_blank">dummy-services.csv</a></small></p>
                
                <div class="mb-3">
                  <input type="file" id="pricingFile" accept=".csv" class="form-control-file mb-2">
                  <button class="btn btn-primary btn-sm mr-2" onclick="importPricing()">Import CSV</button>
                  <button class="btn btn-secondary btn-sm mr-2" onclick="exportPricing()">Export CSV</button>
                  <button class="btn btn-success btn-sm mr-2" onclick="savePricingToFirestore()">Save to Firestore</button>
                  <button class="btn btn-info btn-sm mr-2" onclick="syncPricingWithCloud()">Sync with Cloud</button>
                  <button class="btn btn-warning btn-sm" onclick="loadDummyServices()">Load Dummy Services</button>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-sm" id="pricingTable">
                    <thead>
                      <tr>
                        <th>Service</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Active</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="4" class="text-muted text-center">No data loaded</td></tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info">
                  <small><strong>BLVD Export Headers (required):</strong><br>
                  category,service,price,duration_min,sku,active<br>
                  <em>All fields saved to Firestore pricing collection</em>
                  </small>
                </div>
              </div>
            </div>
          </div>

          <!-- Leads & Follow-ups -->
          <div class="col-xl-6">
            <div class="card">
              <div class="card-body">
                <h4 class="header-title">Leads CSV</h4>
                <p class="text-muted">Import/Export leads data with locked 15-column schema.</p>
                <p class="text-muted"><small>Download sample: <a href="assets/data/dummy-leads.csv" target="_blank">dummy-leads.csv</a></small></p>
                
                <div class="mb-3">
                  <input type="file" id="leadsFile" accept=".csv" class="form-control-file mb-2">
                  <button class="btn btn-primary btn-sm mr-2" onclick="importLeads()">Import Leads CSV</button>
                  <button class="btn btn-secondary btn-sm mr-2" onclick="exportLeads()">Export Leads CSV</button>
                  <button class="btn btn-info btn-sm mr-2" onclick="syncLeadsWithCloud()">Sync with Cloud</button>
                  <button class="btn btn-warning btn-sm" onclick="loadDummyLeads()">Load Dummy Leads</button>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-sm" id="leadsTable">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Source</th>
                        <th>Category</th>
                        <th>Service</th>
                        <th>Value</th>
                        <th>Priority</th>
                        <th>Stage</th>
                        <th>Created</th>
                        <th>Appt Date</th>
                        <th>Due Date</th>
                        <th>Due Time</th>
                        <th>Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="15" class="text-muted text-center">No data loaded</td></tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="alert alert-info">
                  <small><strong>CSV Headers (required order):</strong><br>
                  id,name,phone,email,source,category,service,value,priority,stage,created,apptDate,dueDate,dueTime,notes
                  </small>
                </div>
                
                <div id="leadsStatus" class="text-muted"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Roles Management -->
        <div class="row">
          <div class="col-xl-12">
            <div class="card">
              <div class="card-body">
                <h4 class="header-title">User Roles Management</h4>
                <p class="text-muted">Manage user roles and permissions. Only admins can modify roles.</p>
                
                <div class="table-responsive">
                  <table class="table table-striped" id="usersTable">
                    <thead>
                      <tr>
                        <th>Email</th>
                        <th>Display Name</th>
                        <th>Current Role</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableBody">
                      <tr>
                        <td colspan="4" class="text-center text-muted">Loading users...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <button id="btnRefreshUsers" class="btn btn-outline-primary">Refresh Users</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Firestore Seed Data (Admin Only) -->
        <div class="row" id="seedDataSection" style="display: none;">
          <div class="col-xl-12">
            <div class="card border-warning">
              <div class="card-body">
                <h4 class="header-title text-warning">🔧 Developer Tools</h4>
                <p class="text-muted">Populate Firestore collections with dummy data for testing dashboards.</p>
                
                <div class="alert alert-warning">
                  <small><strong>⚠️ Warning:</strong> This will add sample data to your Firestore collections (leads, pricing, inventory). 
                  Existing documents with the same IDs will be preserved.</small>
                </div>
                
                <button type="button" class="btn btn-warning" id="btnSeedData">
                  <i class="fas fa-database"></i> Seed Firestore with Dummy Data
                </button>
                
                <button type="button" class="btn btn-info ml-2" id="btnTestLeads">
                  <i class="fas fa-bug"></i> Test Load Leads
                </button>
                
                <div id="seedStatus" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- container -->

      <footer class="footer text-center text-sm-left">
        &copy; 2020 Crovex
        <span class="text-muted d-none d-sm-inline-block float-right">Crafted with <i class="mdi mdi-heart text-danger"></i> by Mannatthemes</span>
      </footer>
    </div>
  </div>

  <!-- Core JS -->
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/metismenu.min.js"></script>
  <script src="assets/js/waves.js"></script>
  <script src="assets/js/feather.min.js"></script>
  <script src="assets/js/jquery.slimscroll.min.js"></script>
  <script src="assets/js/jquery-ui.min.js"></script>

  <!-- Plugins -->
  <script src="plugins/moment/moment.js"></script>
  <script src="plugins/apexcharts/apexcharts.min.js"></script>
  <script src="plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
  <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
  <script src="plugins/flot-chart/jquery.flot.js"></script>
  <script src="plugins/flot-chart/jquery.flot.saturated.js"></script>
  <script src="plugins/flot-chart/jquery.flot.browser.js"></script>
  <script src="plugins/flot-chart/jquery.flot.drawSeries.js"></script>
  <script src="plugins/flot-chart/jquery.flot.uiConstants.js"></script>

  <!-- Page init -->

  <!-- App js -->
  <script src="assets/js/app.js"></script>

  <!-- Firebase SDK -->
  <script type="module" src="assets/js/firebase-config.js"></script>
  <script src="assets/js/firebase-seed.js"></script>

  <!-- Admin CSV Functions -->
  <script>
    let pricingData = [];
    let leadsData = [];

    // Simple CSV parser
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (!lines.length) return [];
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const rows = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        rows.push(row);
      }
      return rows;
    }

    // Convert data to CSV
    function dataToCSV(data, headers) {
      if (!data.length) return '';
      const csvRows = [headers.join(',')];
      data.forEach(row => {
        const values = headers.map(header => {
          let value = row[header] || '';
          if (value.includes(',') || value.includes('"')) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        });
        csvRows.push(values.join(','));
      });
      return csvRows.join('\n');
    }

    // Download CSV
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Firestore helper functions
    async function checkAuth() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Please sign in to access Firestore functionality');
        return false;
      }
      return true;
    }

    // QA Test Case: Services CSV Input (BLVD export format)
    // category,service,price,duration_min,sku,active
    // Injectables,Botox,450,30,BTX-001,true
    // Should keep only: service, category, price, active
    // Ignore: duration_min, sku
    
    function importPricing() {
      const file = document.getElementById('pricingFile').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const rawData = parseCSV(e.target.result);
          
          // Validate CSV has data
          if (rawData.length === 0) {
            alert('CSV file is empty');
            return;
          }
          
          // BLVD Export Schema - exact headers validation
          const requiredHeaders = ['category', 'service', 'price', 'duration_min', 'sku', 'active'];
          const firstRow = rawData[0];
          const csvHeaders = Object.keys(firstRow);
          
          // Check for all required headers (case-insensitive)
          const missingHeaders = requiredHeaders.filter(header => 
            !csvHeaders.some(h => h.toLowerCase().trim() === header.toLowerCase())
          );
          
          if (missingHeaders.length > 0) {
            alert('Invalid Services CSV format. Required BLVD export headers: category,service,price,duration_min,sku,active');
            return;
          }
          
          // Process data - all rows with proper field mapping
          pricingData = rawData.map(row => {
            // Parse active field - treat "true", "1", "yes" as true
            const activeValue = (row.active || '').toString().toLowerCase();
            const active = activeValue === 'true' || activeValue === '1' || activeValue === 'yes';
            
            return {
              category: (row.category || '').toString().trim(),
              service: (row.service || '').toString().trim(),
              price: parseFloat(row.price) || 0,
              duration_min: parseInt(row.duration_min) || 0,
              sku: (row.sku || '').toString().trim(),
              active: active
            };
          }).filter(row => row.service.length > 0); // Filter out rows without service name
          
          renderPricingTable();
          const activeCount = pricingData.filter(s => s.active).length;
          alert(`Imported ${pricingData.length} services (${activeCount} active)`);
        } catch (error) {
          console.error('Error importing pricing:', error);
          alert('Error parsing CSV: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    async function exportPricing() {
      try {
        // Export from Firestore pricing collection (BLVD format)
        const snapshot = await db.collection('pricing').get();
        const firestoreData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          firestoreData.push({
            category: data.category || '',
            service: data.service || '',
            price: data.price || 0,
            duration_min: data.duration_min || 0,
            sku: data.sku || '',
            active: data.active || false
          });
        });
        
        const data = firestoreData.length ? firestoreData : pricingData;
        const headers = ['category', 'service', 'price', 'duration_min', 'sku', 'active'];
        const csv = dataToCSV(data, headers);
        downloadCSV(csv, 'services-export.csv');
      } catch (error) {
        console.error('Error exporting from Firestore, using local data:', error);
        const headers = ['category', 'service', 'price', 'duration_min', 'sku', 'active'];
        const csv = dataToCSV(pricingData, headers);
        downloadCSV(csv, 'services-export.csv');
      }
    }

    async function savePricingToFirestore() {
      if (!await checkAuth()) return;
      
      try {
        const batch = db.batch();
        const categoriesMap = {};
        
        pricingData.forEach(row => {
          if (row.service) {
            // Use SKU as doc ID if present, else use slugified service name
            const docId = row.sku || row.service.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const docRef = db.collection('pricing').doc(docId);
            
            // Save to pricing collection with all BLVD fields
            batch.set(docRef, {
              category: row.category,
              service: row.service,
              price: row.price,
              duration_min: row.duration_min,
              sku: row.sku,
              active: row.active
            });
            
            // Track active services by category for secondary collection
            if (row.active && row.category) {
              if (!categoriesMap[row.category]) {
                categoriesMap[row.category] = [];
              }
              categoriesMap[row.category].push(row.service);
            }
          }
        });
        
        // Update services_by_category collection
        Object.keys(categoriesMap).forEach(category => {
          const categoryDocRef = db.collection('services_by_category').doc(category);
          batch.set(categoryDocRef, {
            services: categoriesMap[category]
          });
        });
        
        await batch.commit();
        alert('Services data saved to Firestore (pricing + services_by_category collections)');
      } catch (error) {
        console.error('Error saving to Firestore:', error);
        alert('Error saving to Firestore: ' + error.message);
      }
    }

    async function syncPricingWithCloud() {
      if (!await checkAuth()) return;
      
      try {
        // Save current data to Firestore first
        await savePricingToFirestore();
        
        // Load from Firestore pricing collection - BLVD schema
        const snapshot = await db.collection('pricing').get();
        pricingData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // Load all fields from BLVD schema
          pricingData.push({
            category: data.category || '',
            service: data.service || '',
            price: data.price || 0,
            duration_min: data.duration_min || 0,
            sku: data.sku || '',
            active: data.active || false
          });
        });
        
        renderPricingTable();
        const activeCount = pricingData.filter(s => s.active).length;
        alert(`Synced with Firestore: ${pricingData.length} services (${activeCount} active)`);
      } catch (error) {
        console.error('Error syncing with Firestore:', error);
        alert('Error syncing with Firestore: ' + error.message);
      }
    }

    function renderPricingTable() {
      const tbody = document.querySelector('#pricingTable tbody');
      if (!pricingData.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No data loaded</td></tr>';
        return;
      }
      
      // Table preview shows only: service, category, price, active
      tbody.innerHTML = pricingData.map(row => `
        <tr>
          <td>${row.service || ''}</td>
          <td>${row.category || ''}</td>
          <td>$${parseFloat(row.price || 0).toFixed(2)}</td>
          <td><span class="badge badge-${row.active ? 'success' : 'secondary'}">${row.active ? 'Active' : 'Inactive'}</span></td>
        </tr>
      `).join('');
    }

    // QA Test Case: Leads CSV must have exact headers in order
    // id,name,phone,email,source,category,service,value,priority,stage,created,apptDate,dueDate,dueTime,notes
    // Must have all 15 headers. Success if complete. Fail if missing header.
    
    function importLeads() {
      const file = document.getElementById('leadsFile').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const rawData = parseCSV(e.target.result);
          
          // Validate CSV has data
          if (rawData.length === 0) {
            alert('CSV file is empty');
            return;
          }
          
          // STRICT SCHEMA: Leads CSV - exact headers validation
          const requiredHeaders = ['id','name','phone','email','source','category','service','value','priority','stage','created','apptDate','dueDate','dueTime','notes'];
          const firstRow = rawData[0];
          const csvHeaders = Object.keys(firstRow);
          
          // Check if we have all required headers (ignore extra columns)
          const missingHeaders = requiredHeaders.filter(header => 
            !csvHeaders.some(h => h.toLowerCase().trim() === header.toLowerCase())
          );
          
          if (missingHeaders.length > 0) {
            alert(`Invalid Leads CSV format. Missing headers: ${missingHeaders.join(',')}. Expected headers: ${requiredHeaders.join(',')}`);
            return;
          }
          
          // Process data with strict casting
          leadsData = rawData.map(row => {
            // Generate UUID if id is missing
            const id = (row.id || '').toString().trim() || 'lead-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // Cast value to number
            let value = parseFloat(row.value);
            if (isNaN(value)) value = 0;
            
            // Keep priority as string
            let priority = (row.priority || '').toString().trim();
            
            return {
              id: id,
              name: (row.name || '').toString().trim(),
              phone: (row.phone || '').toString().trim(),
              email: (row.email || '').toString().trim(),
              source: (row.source || '').toString().trim(),
              category: (row.category || '').toString().trim(),
              service: (row.service || '').toString().trim(),
              value: value,
              priority: priority,
              stage: (row.stage || '').toString().trim(),
              created: (row.created || '').toString().trim(),
              apptDate: (row.apptDate || '').toString().trim(),
              dueDate: (row.dueDate || '').toString().trim(),
              dueTime: (row.dueTime || '').toString().trim(),
              notes: (row.notes || '').toString().trim()
            };
          });
          
          renderLeadsTable();
          document.getElementById('leadsStatus').innerHTML = `Imported ${leadsData.length} leads (schema validated)`;
        } catch (error) {
          alert('Error parsing leads CSV: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    async function exportLeads() {
      try {
        // Try to get data from Firestore first, fallback to local data
        const snapshot = await db.collection('leads').get();
        const firestoreData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          firestoreData.push({
            id: data.id || doc.id,
            name: data.name || '',
            phone: data.phone || '',
            email: data.email || '',
            source: data.source || '',
            category: data.category || '',
            service: data.service || '',
            value: data.value || 0,
            priority: data.priority || '',
            stage: data.stage || '',
            created: data.created || '',
            apptDate: data.apptDate || '',
            dueDate: data.dueDate || '',
            dueTime: data.dueTime || '',
            notes: data.notes || ''
          });
        });
        
        const data = firestoreData.length ? firestoreData : leadsData;
        const headers = ['id', 'name', 'phone', 'email', 'source', 'category', 'service', 'value', 'priority', 'stage', 'created', 'apptDate', 'dueDate', 'dueTime', 'notes'];
        const csv = dataToCSV(data, headers);
        downloadCSV(csv, 'leads-export.csv');
      } catch (error) {
        console.error('Error exporting from Firestore, using local data:', error);
        const headers = ['id', 'name', 'phone', 'email', 'source', 'category', 'service', 'value', 'priority', 'stage', 'created', 'apptDate', 'dueDate', 'dueTime', 'notes'];
        const csv = dataToCSV(leadsData, headers);
        downloadCSV(csv, 'leads-export.csv');
      }
    }

    async function syncLeadsWithCloud() {
      if (!await checkAuth()) return;
      
      try {
        // Save current data to Firestore leads collection
        if (leadsData.length) {
          const batch = db.batch();
          
          leadsData.forEach(row => {
            if (row.id) {
              const docRef = db.collection('leads').doc(row.id);
              // SCHEMA ENFORCEMENT: Only save schema-compliant docs
              batch.set(docRef, {
                id: row.id,
                name: row.name || '',
                phone: row.phone || '',
                email: row.email || '',
                source: row.source || '',
                category: row.category || '',
                service: row.service || '',
                value: typeof row.value === 'number' ? row.value : parseFloat(row.value) || 0,
                priority: row.priority,
                stage: row.stage || '',
                created: row.created || '',
                apptDate: row.apptDate || '',
                dueDate: row.dueDate || '',
                dueTime: row.dueTime || '',
                notes: row.notes || ''
              });
            }
          });
          
          await batch.commit();
        }
        
        // Load from Firestore leads collection - schema validation
        const snapshot = await db.collection('leads').get();
        leadsData = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // Only read schema-compliant docs
          if (data.id && data.name !== undefined && data.value !== undefined) {
            leadsData.push({
              id: data.id,
              name: data.name || '',
              phone: data.phone || '',
              email: data.email || '',
              source: data.source || '',
              category: data.category || '',
              service: data.service || '',
              value: data.value || 0,
              priority: data.priority,
              stage: data.stage || '',
              created: data.created || '',
              apptDate: data.apptDate || '',
              dueDate: data.dueDate || '',
              dueTime: data.dueTime || '',
              notes: data.notes || ''
            });
          }
        });
        
        renderLeadsTable();
        document.getElementById('leadsStatus').innerHTML = `Synced ${leadsData.length} leads with Firestore (leads collection)`;
      } catch (error) {
        alert('Error syncing leads with Firestore: ' + error.message);
      }
    }

    function renderLeadsTable() {
      const tbody = document.querySelector('#leadsTable tbody');
      if (!leadsData.length) {
        tbody.innerHTML = '<tr><td colspan="15" class="text-muted text-center">No data loaded</td></tr>';
        return;
      }
      
      tbody.innerHTML = leadsData.map(row => `
        <tr>
          <td>${row.id || ''}</td>
          <td>${row.name || ''}</td>
          <td>${row.phone || ''}</td>
          <td>${row.email || ''}</td>
          <td>${row.source || ''}</td>
          <td>${row.category || ''}</td>
          <td>${row.service || ''}</td>
          <td>$${parseFloat(row.value || 0).toFixed(2)}</td>
          <td><span class="badge badge-${getPriorityColor(row.priority)}">${row.priority || ''}</span></td>
          <td><span class="badge badge-${getStageColor(row.stage)}">${row.stage || ''}</span></td>
          <td>${row.created || ''}</td>
          <td>${row.apptDate || ''}</td>
          <td>${row.dueDate || ''}</td>
          <td>${row.dueTime || ''}</td>
          <td title="${row.notes || ''}">${(row.notes || '').substring(0, 50)}${(row.notes || '').length > 50 ? '...' : ''}</td>
        </tr>
      `).join('');
    }

    function getPriorityColor(priority) {
      switch ((priority || '').toLowerCase()) {
        case 'high': return 'danger';
        case 'medium': return 'warning';
        case 'low': return 'info';
        default: return 'secondary';
      }
    }

    function getStageColor(stage) {
      switch ((stage || '').toLowerCase()) {
        case 'new': return 'primary';
        case 'followup': return 'warning';
        case 'converted': return 'success';
        case 'lost': return 'danger';
        default: return 'secondary';
      }
    }

    // User management functions
    async function loadUsers() {
      try {
        const users = await getAllUsers();
        const tbody = document.getElementById('usersTableBody');
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No users found</td></tr>';
          return;
        }
        
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.email || 'N/A'}</td>
            <td>${user.displayName || 'N/A'}</td>
            <td>
              <span class="badge badge-${getRoleBadgeColor(user.role)}">${user.role || 'frontdesk'}</span>
            </td>
            <td>
              <select class="form-control-sm" onchange="changeUserRole('${user.uid}', this.value)" ${window.currentRole !== 'admin' ? 'disabled' : ''}>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                <option value="frontdesk" ${user.role === 'frontdesk' || !user.role ? 'selected' : ''}>Front Desk</option>
                <option value="marketing" ${user.role === 'marketing' ? 'selected' : ''}>Marketing</option>
              </select>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading users</td></tr>';
      }
    }
    
    function getRoleBadgeColor(role) {
      switch (role) {
        case 'admin': return 'danger';
        case 'marketing': return 'info';
        case 'frontdesk': return 'success';
        default: return 'secondary';
      }
    }
    
    async function changeUserRole(uid, newRole) {
      if (window.currentRole !== 'admin') {
        alert('Only admins can change user roles');
        return;
      }
      
      try {
        const success = await updateUserRole(uid, newRole);
        if (success) {
          alert('User role updated successfully');
          loadUsers(); // Refresh the table
        } else {
          alert('Failed to update user role');
        }
      } catch (error) {
        alert('Error updating user role: ' + error.message);
      }
    }

    // Load existing data on page load
    $(function() {
      feather && feather.replace();
      
      // Load data from Firestore when authenticated
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          try {
            // Load pricing from Firestore - enforce schema compliance
            const pricingSnapshot = await db.collection('pricing').get();
            if (!pricingSnapshot.empty) {
              pricingData = [];
              pricingSnapshot.forEach(doc => {
                const data = doc.data();
                // Only load schema-compliant docs
                if (data.service && data.category !== undefined && data.price !== undefined && data.active !== undefined) {
                  pricingData.push({
                    service: data.service,
                    category: data.category,
                    price: data.price,
                    active: data.active
                  });
                }
              });
              renderPricingTable();
            }
            
            // Load leads from Firestore - enforce schema compliance
            const leadsSnapshot = await db.collection('leads').get();
            if (!leadsSnapshot.empty) {
              leadsData = [];
              leadsSnapshot.forEach(doc => {
                const data = doc.data();
                // Only load schema-compliant docs
                if (data.id && data.name !== undefined && data.value !== undefined) {
                  leadsData.push({
                    id: data.id,
                    name: data.name || '',
                    phone: data.phone || '',
                    email: data.email || '',
                    source: data.source || '',
                    category: data.category || '',
                    service: data.service || '',
                    value: data.value || 0,
                    priority: data.priority,
                    stage: data.stage || '',
                    created: data.created || '',
                    apptDate: data.apptDate || '',
                    dueDate: data.dueDate || '',
                    dueTime: data.dueTime || '',
                    notes: data.notes || ''
                  });
                }
              });
              renderLeadsTable();
              document.getElementById('leadsStatus').innerHTML = `${leadsData.length} schema-compliant leads in Firestore`;
            }
            
            // Load users for management
            loadUsers();
          } catch (error) {
            console.error('Error loading data from Firestore:', error);
          }
        }
      });
      
      // Refresh users button
      document.getElementById('btnRefreshUsers')?.addEventListener('click', loadUsers);
      
      // Seed data button (admin only)
      document.getElementById('btnSeedData')?.addEventListener('click', async function() {
        if (window.currentRole !== 'admin') {
          alert('Only admins can seed data');
          return;
        }
        
        if (!confirm('This will populate Firestore with dummy data for leads, pricing, inventory, vendors, users, campaigns, and revenue. Continue?')) {
          return;
        }
        
        const statusDiv = document.getElementById('seedStatus');
        statusDiv.innerHTML = '<div class="alert alert-info">⏳ Seeding Firestore with dummy data...</div>';
        
        try {
          const result = await seedData();
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              ✅ <strong>Seed completed!</strong><br>
              Inserted: ${result.inserted.leads} leads, ${result.inserted.pricing} pricing, 
              ${result.inserted.inventory} inventory, ${result.inserted.vendors} vendors, 
              ${result.inserted.users} users, ${result.inserted.campaigns} campaigns, 
              ${result.inserted.revenue} revenue records<br>
              <strong>Total: ${result.inserted.total} documents</strong>
            </div>
          `;
          alert('Dummy data seeded successfully! Check dashboards for updated charts.');
        } catch (error) {
          console.error('Seed failed:', error);
          statusDiv.innerHTML = `<div class="alert alert-danger">❌ Seed failed: ${error.message}</div>`;
          alert('Seed operation failed. Check console for details.');
        }
      });
      
      // Test load leads button
      document.getElementById('btnTestLeads')?.addEventListener('click', async function() {
        console.log('=== TESTING LEADS LOAD ===');
        try {
          const snapshot = await db.collection('leads').limit(5).get();
          if (snapshot.empty) {
            console.log('No leads found in Firestore');
            alert('No leads found in Firestore. Try seeding data first.');
            return;
          }
          
          console.log(`Found ${snapshot.size} leads:`);
          snapshot.forEach(doc => {
            console.log(`Lead ${doc.id}:`, doc.data());
          });
          alert(`Found ${snapshot.size} leads. Check browser console for details.`);
        } catch (error) {
          console.error('Error loading leads:', error);
          alert('Error loading leads. Check console for details.');
        }
      });
      
      // Show/hide seed section based on role
      auth.onAuthStateChanged(async (user) => {
        if (user && window.currentRole === 'admin') {
          document.getElementById('seedDataSection').style.display = 'block';
        } else {
          document.getElementById('seedDataSection').style.display = 'none';
        }
      });
    });

    // Load dummy Services CSV
    async function loadDummyServices() {
      try {
        const response = await fetch('/test-data/services-sample.csv');
        if (!response.ok) {
          throw new Error('Could not load dummy services CSV');
        }
        const csvText = await response.text();
        
        // Show spinner
        const statusDiv = document.createElement('div');
        statusDiv.innerHTML = '⏳ Loading dummy services...';
        statusDiv.id = 'dummyServicesStatus';
        document.querySelector('#pricingTable').parentNode.appendChild(statusDiv);
        
        // Parse and process like regular import
        const rawData = parseCSV(csvText);
        if (rawData.length === 0) {
          throw new Error('Dummy services CSV is empty');
        }
        
        // Process with same validation as importPricing - BLVD schema
        const requiredHeaders = ['category', 'service', 'price', 'duration_min', 'sku', 'active'];
        const firstRow = rawData[0];
        const csvHeaders = Object.keys(firstRow);
        
        const missingHeaders = requiredHeaders.filter(header => 
          !csvHeaders.some(h => h.toLowerCase().trim() === header.toLowerCase())
        );
        
        if (missingHeaders.length > 0) {
          throw new Error('Dummy services CSV missing required BLVD headers');
        }
        
        // Process all services and prepare for Firestore (pricing collection)
        const batch = db.batch();
        const categoriesMap = {};
        let processedCount = 0;
        
        for (const row of rawData) {
          // Parse active field like importPricing
          const activeValue = (row.active || '').toString().toLowerCase();
          const active = activeValue === 'true' || activeValue === '1' || activeValue === 'yes';
          
          const serviceData = {
            category: row.category || '',
            service: row.service || '',
            price: parseFloat(row.price) || 0,
            duration_min: parseInt(row.duration_min) || 0,
            sku: row.sku || '',
            active: active
          };
          
          // Use SKU as doc ID if present, else slugified service name
          const docId = row.sku || row.service.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
          const docRef = db.collection('pricing').doc(docId);
          batch.set(docRef, serviceData);
          
          // Track for services_by_category
          if (active && row.category) {
            if (!categoriesMap[row.category]) {
              categoriesMap[row.category] = [];
            }
            categoriesMap[row.category].push(row.service);
          }
          
          processedCount++;
        }
        
        // Update services_by_category collection
        Object.keys(categoriesMap).forEach(category => {
          const categoryDocRef = db.collection('services_by_category').doc(category);
          batch.set(categoryDocRef, {
            services: categoriesMap[category]
          });
        });
        
        // Commit to Firestore
        await batch.commit();
        
        // Update UI
        const activeCount = Object.values(categoriesMap).flat().length;
        document.getElementById('dummyServicesStatus').innerHTML = `✅ Loaded ${processedCount} dummy services (${activeCount} active) to Firestore`;
        setTimeout(() => {
          document.getElementById('dummyServicesStatus')?.remove();
        }, 3000);
        
        // Refresh table
        await syncPricingWithCloud();
        
      } catch (error) {
        console.error('Error loading dummy services:', error);
        const statusDiv = document.getElementById('dummyServicesStatus');
        if (statusDiv) {
          statusDiv.innerHTML = `⚠️ Failed to load dummy services: ${error.message}`;
          setTimeout(() => statusDiv.remove(), 5000);
        } else {
          alert(`Failed to load dummy services: ${error.message}`);
        }
      }
    }

    // Global test function for debugging
    async function testLoadLeads() {
      console.log('=== GLOBAL TEST LOAD LEADS ===');
      try {
        const snapshot = await db.collection('leads').get();
        console.log(`Total leads in Firestore: ${snapshot.size}`);
        snapshot.forEach((doc, index) => {
          if (index < 5) { // Only log first 5 for readability
            console.log(`Lead ${doc.id}:`, doc.data());
          }
        });
        return snapshot.size;
      } catch (error) {
        console.error('Error in testLoadLeads:', error);
        return 0;
      }
    }
    window.testLoadLeads = testLoadLeads;

    // Load dummy Leads CSV
    async function loadDummyLeads() {
      try {
        const response = await fetch('/test-data/leads-sample.csv');
        if (!response.ok) {
          throw new Error('Could not load dummy leads CSV');
        }
        const csvText = await response.text();
        
        // Show spinner
        const statusDiv = document.createElement('div');
        statusDiv.innerHTML = '⏳ Loading dummy leads...';
        statusDiv.id = 'dummyLeadsStatus';
        document.querySelector('#leadsTable').parentNode.appendChild(statusDiv);
        
        // Parse and process like regular import
        const rawData = parseCSV(csvText);
        if (rawData.length === 0) {
          throw new Error('Dummy leads CSV is empty');
        }
        
        // Validate headers (15 exact columns)
        const requiredHeaders = ['id','name','phone','email','source','category','service','value','priority','stage','created','apptDate','dueDate','dueTime','notes'];
        const firstRow = rawData[0];
        const csvHeaders = Object.keys(firstRow);
        
        if (csvHeaders.length !== requiredHeaders.length) {
          throw new Error('Dummy leads CSV must have exactly 15 columns');
        }
        
        // Check header order
        for (let i = 0; i < requiredHeaders.length; i++) {
          if (csvHeaders[i].toLowerCase().trim() !== requiredHeaders[i].toLowerCase()) {
            throw new Error(`Dummy leads CSV header mismatch at position ${i+1}. Expected: ${requiredHeaders[i]}, Got: ${csvHeaders[i]}`);
          }
        }
        
        // Batch write to Firestore
        const batch = db.batch();
        let processedCount = 0;
        
        for (const row of rawData) {
          const leadId = row.id || generateUUID();
          const leadData = {
            id: leadId,
            name: row.name || '',
            phone: row.phone || '',
            email: row.email || '',
            source: row.source || '',
            category: row.category || '',
            service: row.service || '',
            value: parseFloat(row.value) || 0,
            priority: row.priority || '',
            stage: row.stage || 'New',
            created: row.created || new Date().toISOString(),
            apptDate: row.apptDate || '',
            dueDate: row.dueDate || '',
            dueTime: row.dueTime || '',
            notes: row.notes || ''
          };
          
          const docRef = db.collection('leads').doc(leadId);
          batch.set(docRef, leadData);
          processedCount++;
        }
        
        // Commit to Firestore
        await batch.commit();
        
        // Update UI
        document.getElementById('dummyLeadsStatus').innerHTML = `✅ Loaded ${processedCount} dummy leads to Firestore`;
        setTimeout(() => {
          document.getElementById('dummyLeadsStatus')?.remove();
        }, 3000);
        
        // Refresh table
        await syncLeadsWithCloud();
        
      } catch (error) {
        console.error('Error loading dummy leads:', error);
        const statusDiv = document.getElementById('dummyLeadsStatus');
        if (statusDiv) {
          statusDiv.innerHTML = `⚠️ Failed to load dummy leads: ${error.message}`;
          setTimeout(() => statusDiv.remove(), 5000);
        } else {
          alert(`Failed to load dummy leads: ${error.message}`);
        }
      }
    }
  </script>
</body>
</html>